# =============================================================================
# TIKTOK CLONE - INFRASTRUCTURE WORKFLOW
# =============================================================================
# Workflow nÃ y quáº£n lÃ½ viá»‡c deploy infrastructure changes
# Bao gá»“m: Helm charts, Kubernetes manifests, ArgoCD configurations
#
# TRIGGER:
# - Khi cÃ³ thay Ä‘á»•i trong thÆ° má»¥c helm/, k8s/, argocd/, terraform/
# =============================================================================

name: Infrastructure Management

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'helm/**'
      - 'k8s/**'
      - 'argocd/**'
      - 'terraform/**'
      - 'monitoring/**'

  pull_request:
    branches:
      - main
    paths:
      - 'helm/**'
      - 'k8s/**'
      - 'argocd/**'
      - 'terraform/**'

  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - validate # Chá»‰ validate, khÃ´ng apply
          - plan # Terraform plan
          - apply # Apply changes

env:
  HELM_VERSION: '3.14.0'
  KUBECTL_VERSION: '1.29.0'
  TERRAFORM_VERSION: '1.7.0'

jobs:
  # ===========================================================================
  # JOB 1: VALIDATE HELM CHARTS
  # Kiá»ƒm tra syntax vÃ  lint Helm charts
  # ===========================================================================
  validate-helm:
    name: ðŸ“‹ Validate Helm Charts
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Setup Helm
      - name: ðŸ”§ Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      # Lint Helm charts
      - name: ðŸ” Lint Helm charts
        run: |
          echo "ðŸ” Linting Helm charts..."

          # Lint main chart
          helm lint helm/tiktok-clone/

          # Lint vá»›i tá»«ng values file
          for values in helm/tiktok-clone/values*.yaml; do
            echo "Linting with $values..."
            helm lint helm/tiktok-clone/ -f "$values"
          done

          echo "âœ… Helm lint passed"

      # Template vÃ  validate
      - name: ðŸ“„ Template Helm charts
        run: |
          echo "ðŸ“„ Generating Helm templates..."

          # Template cho tá»«ng environment
          for env in dev staging prod; do
            VALUES_FILE="helm/tiktok-clone/values-${env}.yaml"
            OUTPUT_DIR="rendered/${env}"

            if [ -f "$VALUES_FILE" ]; then
              mkdir -p "$OUTPUT_DIR"
              helm template tiktok-clone helm/tiktok-clone/ \
                -f helm/tiktok-clone/values.yaml \
                -f "$VALUES_FILE" \
                --output-dir "$OUTPUT_DIR"

              echo "âœ… Generated templates for $env"
            fi
          done

      # Validate vá»›i kubeval/kubeconform
      - name: ðŸ” Validate Kubernetes manifests
        run: |
          echo "ðŸ” Validating Kubernetes manifests..."

          # Install kubeconform
          curl -sL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          chmod +x kubeconform

          # Validate rendered templates
          find rendered/ -name "*.yaml" -exec ./kubeconform -summary {} \;

          echo "âœ… Kubernetes manifest validation passed"

      # Upload rendered templates as artifact
      - name: ðŸ“¤ Upload rendered templates
        uses: actions/upload-artifact@v4
        with:
          name: helm-rendered-templates
          path: rendered/
          retention-days: 7

  # ===========================================================================
  # JOB 2: VALIDATE KUBERNETES MANIFESTS
  # Kiá»ƒm tra cÃ¡c file K8s manifest trong thÆ° má»¥c k8s/
  # ===========================================================================
  validate-k8s:
    name: ðŸ“‹ Validate K8s Manifests
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Validate vá»›i kubeconform
      - name: ðŸ” Validate manifests
        run: |
          # Install kubeconform
          curl -sL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          chmod +x kubeconform

          # Validate k8s/ directory
          echo "ðŸ” Validating k8s/ manifests..."
          find k8s/ -name "*.yaml" -exec ./kubeconform -summary {} \;

          # Validate argocd/ directory
          echo "ðŸ” Validating argocd/ manifests..."
          find argocd/ -name "*.yaml" -exec ./kubeconform -summary {} \;

          echo "âœ… All manifests are valid"

      # Check for security issues with kube-score
      - name: ðŸ”’ Security scan with kube-score
        run: |
          # Install kube-score
          curl -sL https://github.com/zegl/kube-score/releases/download/v1.17.0/kube-score_1.17.0_linux_amd64.tar.gz | tar xz
          chmod +x kube-score

          echo "ðŸ”’ Running kube-score security scan..."

          # Scan k8s manifests
          find k8s/ -name "*.yaml" -exec ./kube-score score {} \; || true

          echo "âœ… Security scan completed"
        continue-on-error: true

  # ===========================================================================
  # JOB 3: TERRAFORM PLAN
  # Táº¡o Terraform plan cho infrastructure changes
  # ===========================================================================
  terraform-plan:
    name: ðŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && inputs.action != 'validate')

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Setup Terraform
      - name: ðŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      # Terraform Init
      - name: ðŸ”§ Terraform Init
        working-directory: terraform
        run: |
          terraform init -backend=false
        env:
          # AWS credentials náº¿u cÃ³
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # Terraform Validate
      - name: ðŸ” Terraform Validate
        working-directory: terraform
        run: terraform validate

      # Terraform Format Check
      - name: âœ¨ Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check -recursive

      # Terraform Plan
      - name: ðŸ“‹ Terraform Plan
        working-directory: terraform
        run: |
          terraform plan -out=tfplan -no-color
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        continue-on-error: true

      # Save plan output
      - name: ðŸ“¤ Upload Terraform plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan
          retention-days: 7

  # ===========================================================================
  # JOB 4: SYNC ARGOCD APPLICATIONS
  # Cáº­p nháº­t ArgoCD applications khi cÃ³ thay Ä‘á»•i
  # ===========================================================================
  sync-argocd:
    name: ðŸ”„ Sync ArgoCD
    runs-on: ubuntu-latest
    needs: [validate-helm, validate-k8s]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Apply ArgoCD configurations
      - name: ðŸ”„ Update ArgoCD configurations
        run: |
          echo "ðŸ”„ Syncing ArgoCD configurations..."

          if [ -n "${{ secrets.ARGOCD_SERVER }}" ]; then
            # Install ArgoCD CLI
            curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
            chmod +x argocd

            # Login
            ./argocd login ${{ secrets.ARGOCD_SERVER }} \
              --username ${{ secrets.ARGOCD_USERNAME }} \
              --password ${{ secrets.ARGOCD_PASSWORD }} \
              --insecure

            # Refresh applications to pick up new configurations
            for app in tiktok-clone-dev tiktok-clone-staging tiktok-clone-prod; do
              echo "Refreshing $app..."
              ./argocd app get $app --refresh || true
            done

            echo "âœ… ArgoCD configurations synced"
          else
            echo "âš ï¸ ArgoCD not configured, skipping sync"
          fi

  # ===========================================================================
  # JOB 5: APPLY TERRAFORM (Manual approval required)
  # ===========================================================================
  terraform-apply:
    name: ðŸš€ Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'workflow_dispatch' &&
      inputs.action == 'apply'

    # YÃªu cáº§u approval
    environment:
      name: infrastructure

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: ðŸ“¥ Download Terraform plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform/

      - name: ðŸš€ Terraform Apply
        working-directory: terraform
        run: |
          terraform init
          terraform apply -auto-approve tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # ===========================================================================
  # JOB 6: SUMMARY
  # ===========================================================================
  summary:
    name: ðŸ“Š Infrastructure Summary
    runs-on: ubuntu-latest
    needs: [validate-helm, validate-k8s, terraform-plan, sync-argocd]
    if: always()

    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "# ðŸ“Š Infrastructure Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Helm Validation | ${{ needs.validate-helm.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| K8s Validation | ${{ needs.validate-k8s.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Plan | ${{ needs.terraform-plan.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD Sync | ${{ needs.sync-argocd.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
