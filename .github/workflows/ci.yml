# =============================================================================
# TIKTOK CLONE - CI PIPELINE (CONTINUOUS INTEGRATION)
# =============================================================================
# Pipeline n√†y ch·∫°y m·ªói khi c√≥ code m·ªõi ƒë∆∞·ª£c push ho·∫∑c t·∫°o Pull Request
# M·ª•c ƒë√≠ch: Ki·ªÉm tra ch·∫•t l∆∞·ª£ng code tr∆∞·ªõc khi merge v√†o nh√°nh ch√≠nh
#
# C√ÅC STAGES:
# 1. Lint & Format Check - Ki·ªÉm tra code style
# 2. Unit Tests - Ch·∫°y unit tests v·ªõi coverage
# 3. Security Scan - Qu√©t l·ªó h·ªïng b·∫£o m·∫≠t
# 4. Build Validation - Ki·ªÉm tra code c√≥ th·ªÉ build ƒë∆∞·ª£c kh√¥ng
# =============================================================================

name: CI - Continuous Integration

# =============================================================================
# TRIGGER CONDITIONS
# Khi n√†o pipeline s·∫Ω ch·∫°y?
# =============================================================================
on:
  # Ch·∫°y khi c√≥ Pull Request v√†o c√°c nh√°nh ch√≠nh
  pull_request:
    branches:
      - main
      - develop
      - 'release/*' # C√°c nh√°nh release nh∆∞ release/1.0.0
    # Ch·ªâ ch·∫°y khi c√≥ thay ƒë·ªïi c√°c file li√™n quan ƒë·∫øn code
    paths:
      - 'apps/**'
      - 'libs/**'
      - 'package*.json'
      - 'tsconfig*.json'
      - '.github/workflows/ci.yml'

  # Ch·∫°y khi push code (kh√¥ng qua PR)
  push:
    branches:
      - main
      - develop

  # Cho ph√©p ch·∫°y th·ªß c√¥ng t·ª´ GitHub UI
  workflow_dispatch:

# =============================================================================
# ENVIRONMENT VARIABLES
# C√°c bi·∫øn m√¥i tr∆∞·ªùng d√πng chung cho to√†n b·ªô pipeline
# =============================================================================
env:
  # Phi√™n b·∫£n Node.js s·ª≠ d·ª•ng
  NODE_VERSION: '20.x'

  # Timezone cho CI (ƒë·∫£m b·∫£o logs c√≥ th·ªùi gian ƒë√∫ng)
  TZ: 'Asia/Ho_Chi_Minh'

  # Cache key prefix - d√πng ƒë·ªÉ invalidate cache khi c·∫ßn
  CACHE_VERSION: v1

# =============================================================================
# CONCURRENCY
# H·ªßy c√°c pipeline c≈© n·∫øu c√≥ pipeline m·ªõi tr√™n c√πng branch/PR
# Gi√∫p ti·∫øt ki·ªám t√†i nguy√™n v√† th·ªùi gian ch·ªù
# =============================================================================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# =============================================================================
# JOBS DEFINITION
# =============================================================================
jobs:
  # ===========================================================================
  # JOB 1: LINT & FORMAT CHECK
  # Ki·ªÉm tra code style theo chu·∫©n ESLint v√† Prettier
  # ===========================================================================
  lint:
    name: üîç Lint & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Timeout sau 10 ph√∫t n·∫øu job ch·∫°y qu√° l√¢u

    steps:
      # B∆∞·ªõc 1: Checkout code t·ª´ repository
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch ƒë·∫ßy ƒë·ªß history ƒë·ªÉ c√≥ th·ªÉ so s√°nh changes
          fetch-depth: 0

      # B∆∞·ªõc 2: Setup Node.js v·ªõi caching
      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # S·ª≠ d·ª•ng npm cache ƒë·ªÉ tƒÉng t·ªëc install dependencies
          cache: 'npm'

      # B∆∞·ªõc 3: Install dependencies
      # --prefer-offline: ∆Øu ti√™n d√πng cache
      # --no-audit: B·ªè qua audit ƒë·ªÉ tƒÉng t·ªëc (ƒë√£ c√≥ job ri√™ng cho security)
      - name: üìö Install dependencies
        run: npm ci --prefer-offline --no-audit

      # B∆∞·ªõc 4: Ch·∫°y ESLint ki·ªÉm tra code quality
      - name: üîç Run ESLint
        run: npm run lint
        # Ti·∫øp t·ª•c ch·∫°y c√°c step kh√°c n·∫øu lint fail
        # ƒë·ªÉ xem ƒë∆∞·ª£c t·∫•t c·∫£ l·ªói
        continue-on-error: false

      # B∆∞·ªõc 5: Ki·ªÉm tra format code v·ªõi Prettier
      - name: ‚ú® Check code formatting
        run: npx prettier --check "apps/**/*.ts" "libs/**/*.ts"

      # B∆∞·ªõc 6: Ki·ªÉm tra TypeScript types
      - name: üìù TypeScript type check
        run: npx tsc --noEmit

  # ===========================================================================
  # JOB 2: UNIT TESTS
  # Ch·∫°y unit tests v√† t·∫°o b√°o c√°o coverage
  # ===========================================================================
  test:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # ƒê·ª£i lint job ho√†n th√†nh tr∆∞·ªõc
    needs: lint

    # ---------------------------------------------------------------------------
    # SERVICES
    # C√°c container services c·∫ßn thi·∫øt cho tests
    # ---------------------------------------------------------------------------
    services:
      # PostgreSQL database cho integration tests
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tiktok_clone_test
        # Health check ƒë·ªÉ ƒë·∫£m b·∫£o DB s·∫µn s√†ng tr∆∞·ªõc khi ch·∫°y tests
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      # Redis cache
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci --prefer-offline --no-audit

      # Ch·∫°y unit tests v·ªõi coverage report
      - name: üß™ Run unit tests
        run: npm run test:cov
        env:
          # Environment variables cho tests
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          DB_NAME: tiktok_clone_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-secret-key
          JWT_EXPIRES_IN: 1h

      # Upload coverage report l√™n Codecov ƒë·ªÉ tracking
      - name: üìä Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: tiktok-clone-coverage
          # Token t·ª´ Codecov (c·∫ßn setup trong repository secrets)
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false # Kh√¥ng fail CI n·∫øu upload th·∫•t b·∫°i

      # L∆∞u coverage report nh∆∞ artifact ƒë·ªÉ review sau
      - name: üìÅ Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7 # Gi·ªØ artifact trong 7 ng√†y

  # ===========================================================================
  # JOB 3: SECURITY SCAN
  # Qu√©t l·ªó h·ªïng b·∫£o m·∫≠t trong dependencies v√† source code
  # ===========================================================================
  security:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Ch·∫°y song song v·ªõi lint ƒë·ªÉ ti·∫øt ki·ªám th·ªùi gian

    # Permissions c·∫ßn thi·∫øt ƒë·ªÉ upload security results
    permissions:
      contents: read
      security-events: write # ƒê·ªÉ upload SARIF results

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # Qu√©t v·ªõi Trivy - c√¥ng c·ª• security scan ph·ªï bi·∫øn
      - name: üîç Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs' # Scan filesystem
          scan-ref: '.' # Scan th∆∞ m·ª•c hi·ªán t·∫°i
          format: 'sarif' # Output format cho GitHub Security
          output: 'trivy-results.sarif'
          # Ch·ªâ b√°o c√°o l·ªói HIGH v√† CRITICAL
          severity: 'HIGH,CRITICAL'
          # B·ªè qua c√°c vulnerability ch∆∞a c√≥ fix
          ignore-unfixed: true

      # Upload k·∫øt qu·∫£ l√™n GitHub Security tab
      - name: üì§ Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        # Ti·∫øp t·ª•c n·∫øu upload th·∫•t b·∫°i (c√≥ th·ªÉ do permissions)
        if: always()

      # Ch·∫°y npm audit ƒë·ªÉ ki·ªÉm tra dependencies
      - name: üîê Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true # Kh√¥ng fail CI, ch·ªâ c·∫£nh b√°o

      # Ki·ªÉm tra secrets c√≥ b·ªã commit v√†o repo kh√¥ng
      - name: üîë Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified
        continue-on-error: true

  # ===========================================================================
  # JOB 4: BUILD VALIDATION
  # Ki·ªÉm tra t·∫•t c·∫£ services c√≥ th·ªÉ build th√†nh c√¥ng kh√¥ng
  # ===========================================================================
  build-check:
    name: üèóÔ∏è Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci --prefer-offline --no-audit

      # Build t·∫•t c·∫£ services
      - name: üèóÔ∏è Build all services
        run: npm run build

      # Ki·ªÉm tra output build c√≥ ƒë·∫ßy ƒë·ªß kh√¥ng
      - name: ‚úÖ Verify build output
        run: |
          echo "Checking build outputs..."
          # Ki·ªÉm tra c√°c th∆∞ m·ª•c dist ƒë∆∞·ª£c t·∫°o ra
          ls -la dist/apps/ || echo "Warning: dist/apps not found"

          # Ki·ªÉm tra t·ª´ng service
          for service in api-gateway auth-service video-service interaction-service notification-service; do
            if [ -d "dist/apps/$service" ]; then
              echo "‚úÖ $service build successful"
            else
              echo "‚ùå $service build missing"
              exit 1
            fi
          done

  # ===========================================================================
  # JOB 5: E2E TESTS (Optional - ch·∫°y tr√™n nh√°nh main)
  # End-to-end tests ki·ªÉm tra to√†n b·ªô flow
  # ===========================================================================
  e2e-test:
    name: üéØ E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test, build-check]
    # Ch·ªâ ch·∫°y E2E tests tr√™n nh√°nh main ƒë·ªÉ ti·∫øt ki·ªám th·ªùi gian
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tiktok_clone_e2e
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: üéØ Run E2E tests
        run: npm run test:e2e
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: postgres
          DB_PASSWORD: postgres
          DB_NAME: tiktok_clone_e2e
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: e2e-test-secret

  # ===========================================================================
  # JOB 6: CI STATUS CHECK
  # Job t·ªïng h·ª£p k·∫øt qu·∫£ ƒë·ªÉ GitHub c√≥ th·ªÉ check tr∆∞·ªõc khi merge
  # ===========================================================================
  ci-status:
    name: ‚úÖ CI Status Check
    runs-on: ubuntu-latest
    needs: [lint, test, security, build-check]
    # Lu√¥n ch·∫°y job n√†y ƒë·ªÉ b√°o c√°o status
    if: always()

    steps:
      - name: üìã Check all jobs status
        run: |
          echo "=== CI Pipeline Results ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Build: ${{ needs.build-check.result }}"
          echo "=========================="

          # Fail n·∫øu b·∫•t k·ª≥ job required n√†o fail
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build-check.result }}" != "success" ]; then
            echo "‚ùå CI Pipeline failed!"
            exit 1
          fi

          echo "‚úÖ CI Pipeline passed!"
