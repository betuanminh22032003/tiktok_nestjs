# =============================================================================
# TIKTOK CLONE - ROLLBACK WORKFLOW
# =============================================================================
# Workflow n√†y cho ph√©p rollback nhanh v·ªÅ version tr∆∞·ªõc trong tr∆∞·ªùng h·ª£p kh·∫©n c·∫•p
#
# USE CASES:
# 1. Production c√≥ bug nghi√™m tr·ªçng c·∫ßn rollback ngay
# 2. Deployment m·ªõi g√¢y ra issues
# 3. C·∫ßn quay v·ªÅ version c·ª• th·ªÉ
# =============================================================================

name: Emergency Rollback

on:
  # Ch·ªâ cho ph√©p trigger th·ªß c√¥ng
  workflow_dispatch:
    inputs:
      environment:
        description: 'M√¥i tr∆∞·ªùng c·∫ßn rollback'
        required: true
        type: choice
        options:
          - production
          - staging
          - dev
      rollback_type:
        description: 'Lo·∫°i rollback'
        required: true
        type: choice
        options:
          - previous # Rollback v·ªÅ version tr∆∞·ªõc ƒë√≥
          - specific # Rollback v·ªÅ version c·ª• th·ªÉ
      target_version:
        description: 'Version c·∫ßn rollback t·ªõi (n·∫øu ch·ªçn "specific")'
        required: false
        type: string
      reason:
        description: 'L√Ω do rollback'
        required: true
        type: string

jobs:
  # ===========================================================================
  # JOB 1: VALIDATE & PREPARE ROLLBACK
  # ===========================================================================
  prepare:
    name: üîç Prepare Rollback
    runs-on: ubuntu-latest

    outputs:
      target_revision: ${{ steps.find-revision.outputs.revision }}
      current_revision: ${{ steps.current.outputs.revision }}
      app_name: ${{ steps.app.outputs.name }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # X√°c ƒë·ªãnh ArgoCD application name
      - name: üéØ Determine ArgoCD app name
        id: app
        run: |
          ENV="${{ inputs.environment }}"

          case $ENV in
            production)
              APP_NAME="tiktok-clone-prod"
              ;;
            staging)
              APP_NAME="tiktok-clone-staging"
              ;;
            dev)
              APP_NAME="tiktok-clone-dev"
              ;;
          esac

          echo "name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "üéØ ArgoCD App: $APP_NAME"

      # L·∫•y current revision
      - name: üìå Get current revision
        id: current
        run: |
          echo "üìå Getting current revision..."

          # N·∫øu c√≥ ArgoCD access
          if [ -n "${{ secrets.ARGOCD_SERVER }}" ]; then
            curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
            chmod +x argocd

            ./argocd login ${{ secrets.ARGOCD_SERVER }} \
              --username ${{ secrets.ARGOCD_USERNAME }} \
              --password ${{ secrets.ARGOCD_PASSWORD }} \
              --insecure

            CURRENT=$(./argocd app get ${{ steps.app.outputs.name }} -o json | jq -r '.status.sync.revision')
            echo "revision=$CURRENT" >> $GITHUB_OUTPUT
            echo "üìå Current revision: $CURRENT"
          else
            echo "revision=unknown" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è ArgoCD not configured, using git history"
          fi

      # T√¨m revision c·∫ßn rollback t·ªõi
      - name: üîç Find target revision
        id: find-revision
        run: |
          ROLLBACK_TYPE="${{ inputs.rollback_type }}"

          if [ "$ROLLBACK_TYPE" == "specific" ]; then
            # S·ª≠ d·ª•ng version ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh
            TARGET_VERSION="${{ inputs.target_version }}"

            if [ -z "$TARGET_VERSION" ]; then
              echo "‚ùå Target version is required for specific rollback"
              exit 1
            fi

            # T√¨m commit/tag t∆∞∆°ng ·ª©ng
            if git rev-parse "v$TARGET_VERSION" >/dev/null 2>&1; then
              REVISION=$(git rev-parse "v$TARGET_VERSION")
            elif git rev-parse "$TARGET_VERSION" >/dev/null 2>&1; then
              REVISION="$TARGET_VERSION"
            else
              echo "‚ùå Version $TARGET_VERSION not found"
              exit 1
            fi
          else
            # Rollback v·ªÅ version tr∆∞·ªõc ƒë√≥
            # L·∫•y revision t·ª´ ArgoCD history ho·∫∑c git
            if [ -n "${{ secrets.ARGOCD_SERVER }}" ]; then
              REVISION=$(./argocd app history ${{ steps.app.outputs.name }} -o json | jq -r '.[1].revision // .[0].revision')
            else
              # Fallback: l·∫•y commit tr∆∞·ªõc ƒë√≥
              REVISION=$(git rev-parse HEAD~1)
            fi
          fi

          echo "revision=$REVISION" >> $GITHUB_OUTPUT
          echo "üéØ Target revision: $REVISION"

  # ===========================================================================
  # JOB 2: APPROVAL (cho Production)
  # ===========================================================================
  approval:
    name: ‚ö†Ô∏è Rollback Approval
    runs-on: ubuntu-latest
    needs: prepare
    if: inputs.environment == 'production'

    # Y√™u c·∫ßu manual approval
    environment:
      name: production-rollback

    steps:
      - name: ‚ö†Ô∏è Rollback Approved
        run: |
          echo "‚ö†Ô∏è PRODUCTION ROLLBACK APPROVED"
          echo "Reason: ${{ inputs.reason }}"
          echo "Target: ${{ needs.prepare.outputs.target_revision }}"
          echo "Approved by: ${{ github.actor }}"

  # ===========================================================================
  # JOB 3: EXECUTE ROLLBACK
  # ===========================================================================
  rollback:
    name: ‚è™ Execute Rollback
    runs-on: ubuntu-latest
    needs: [prepare, approval]
    # Ch·∫°y n·∫øu approval passed ho·∫∑c kh√¥ng ph·∫£i production
    if: |
      always() &&
      (needs.approval.result == 'success' || inputs.environment != 'production') &&
      needs.prepare.result == 'success'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # Th·ª±c hi·ªán rollback qua ArgoCD
      - name: ‚è™ Execute ArgoCD Rollback
        run: |
          echo "‚è™ Executing rollback..."
          echo "Environment: ${{ inputs.environment }}"
          echo "Target revision: ${{ needs.prepare.outputs.target_revision }}"
          echo "Reason: ${{ inputs.reason }}"

          if [ -n "${{ secrets.ARGOCD_SERVER }}" ]; then
            curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
            chmod +x argocd

            ./argocd login ${{ secrets.ARGOCD_SERVER }} \
              --username ${{ secrets.ARGOCD_USERNAME }} \
              --password ${{ secrets.ARGOCD_PASSWORD }} \
              --insecure

            # Th·ª±c hi·ªán rollback
            ./argocd app rollback ${{ needs.prepare.outputs.app_name }} \
              ${{ needs.prepare.outputs.target_revision }}

            # ƒê·ª£i rollback ho√†n th√†nh
            ./argocd app wait ${{ needs.prepare.outputs.app_name }} \
              --timeout 600 \
              --health

            echo "‚úÖ Rollback completed successfully"
          else
            echo "‚ö†Ô∏è ArgoCD not configured"
            echo "Manual rollback required using kubectl or Helm"

            # Alternative: rollback using kubectl
            # kubectl rollout undo deployment/<deployment-name> -n <namespace>
          fi

      # Health check sau rollback
      - name: üè• Post-rollback health check
        run: |
          echo "üè• Running health checks..."

          # ƒê·ª£i pods stabilize
          sleep 30

          # Health check (adjust URL based on environment)
          ENV="${{ inputs.environment }}"
          case $ENV in
            production)
              URL="https://api.tiktok-clone.local/health"
              ;;
            staging)
              URL="https://staging-api.tiktok-clone.local/health"
              ;;
            dev)
              URL="https://dev-api.tiktok-clone.local/health"
              ;;
          esac

          if curl -sf "$URL" --max-time 10; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ö†Ô∏è Health check failed or not accessible"
          fi
        continue-on-error: true

  # ===========================================================================
  # JOB 4: NOTIFY & DOCUMENT
  # ===========================================================================
  notify:
    name: üì¢ Notify & Document
    runs-on: ubuntu-latest
    needs: [prepare, rollback]
    if: always()

    steps:
      # T·∫°o GitHub Issue ƒë·ªÉ document rollback
      - name: üìã Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueTitle = `üîÑ Rollback: ${{ inputs.environment }} - ${new Date().toISOString().split('T')[0]}`;
            const issueBody = `
            ## Rollback Summary

            | Field | Value |
            |-------|-------|
            | **Environment** | ${{ inputs.environment }} |
            | **Type** | ${{ inputs.rollback_type }} |
            | **From Revision** | ${{ needs.prepare.outputs.current_revision }} |
            | **To Revision** | ${{ needs.prepare.outputs.target_revision }} |
            | **Triggered by** | @${{ github.actor }} |
            | **Status** | ${{ needs.rollback.result }} |

            ## Reason
            ${{ inputs.reason }}

            ## Next Steps
            - [ ] Investigate root cause
            - [ ] Create fix PR
            - [ ] Update documentation
            - [ ] Post-mortem meeting scheduled

            ---
            *This issue was created automatically by the Rollback workflow*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['rollback', 'incident', '${{ inputs.environment }}']
            });

      # Slack notification (n·∫øu c√≥ setup)
      - name: üì¢ Send Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ vars.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            -d '{
              "text": "üîÑ *Rollback Executed*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Environment:* ${{ inputs.environment }}\n*Status:* ${{ needs.rollback.result }}\n*Reason:* ${{ inputs.reason }}\n*By:* ${{ github.actor }}"
                  }
                }
              ]
            }'
        continue-on-error: true

      # Summary
      - name: üìä Generate summary
        run: |
          echo "# ‚è™ Rollback Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ needs.rollback.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **From** | ${{ needs.prepare.outputs.current_revision }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **To** | ${{ needs.prepare.outputs.target_revision }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Reason** | ${{ inputs.reason }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Executed by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
