# =============================================================================
# TIKTOK CLONE - SCHEDULED MAINTENANCE WORKFLOWS
# =============================================================================
# CÃ¡c workflows cháº¡y Ä‘á»‹nh ká»³ Ä‘á»ƒ maintain codebase
#
# SCHEDULES:
# - Daily: Security scan
# - Weekly: Dependency audit
# - Monthly: Full analysis
# =============================================================================

name: Scheduled Maintenance

on:
  # Cháº¡y theo schedule - COMMENTED OUT Ä‘á»ƒ tiáº¿t kiá»‡m runner resources
  # Uncomment náº¿u cáº§n auto-run
  # schedule:
  #   # Daily security scan lÃºc 2:00 AM UTC (9:00 AM Vietnam)
  #   - cron: '0 2 * * *'
  #   # Weekly dependency audit vÃ o Chá»§ Nháº­t lÃºc 3:00 AM UTC
  #   - cron: '0 3 * * 0'

  # Cho phÃ©p trigger thá»§ cÃ´ng
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run'
        required: true
        type: choice
        options:
          - security-scan
          - dependency-audit
          - performance-analysis
          - all

env:
  NODE_VERSION: '20.x'

jobs:
  # ===========================================================================
  # JOB 1: DAILY SECURITY SCAN
  # QuÃ©t báº£o máº­t hÃ ng ngÃ y
  # ===========================================================================
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 2 * * *' ||
      (github.event_name == 'workflow_dispatch' && (inputs.task == 'security-scan' || inputs.task == 'all'))

    permissions:
      contents: read
      security-events: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # QuÃ©t vá»›i Trivy
      - name: ðŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'MEDIUM,HIGH,CRITICAL'

      - name: ðŸ“¤ Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      # QuÃ©t vá»›i Snyk (náº¿u cÃ³ token)
      - name: ðŸ” Run Snyk security scan
        if: secrets.SNYK_TOKEN != ''
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

      # Kiá»ƒm tra secrets bá»‹ leak
      - name: ðŸ”‘ Check for leaked secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

      # Táº¡o summary report
      - name: ðŸ“Š Generate security report
        run: |
          echo "# ðŸ”’ Daily Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy scan: See Security tab for details" >> $GITHUB_STEP_SUMMARY
          echo "- Secret scan: Completed" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 2: WEEKLY DEPENDENCY AUDIT
  # Kiá»ƒm tra dependencies hÃ ng tuáº§n
  # ===========================================================================
  dependency-audit:
    name: ðŸ“¦ Dependency Audit
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 3 * * 0' ||
      (github.event_name == 'workflow_dispatch' && (inputs.task == 'dependency-audit' || inputs.task == 'all'))

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      # npm audit
      - name: ðŸ” Run npm audit
        id: npm-audit
        run: |
          npm audit --json > npm-audit.json || true

          # Parse káº¿t quáº£
          CRITICAL=$(cat npm-audit.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat npm-audit.json | jq '.metadata.vulnerabilities.high // 0')
          MODERATE=$(cat npm-audit.json | jq '.metadata.vulnerabilities.moderate // 0')
          LOW=$(cat npm-audit.json | jq '.metadata.vulnerabilities.low // 0')

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

      # Kiá»ƒm tra outdated packages
      - name: ðŸ“‹ Check outdated packages
        run: |
          npm outdated --json > outdated.json || true

          echo "## ðŸ“¦ Outdated Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -s outdated.json ]; then
            echo "| Package | Current | Wanted | Latest |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|---------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            cat outdated.json | jq -r 'to_entries[] | "| \(.key) | \(.value.current) | \(.value.wanted) | \(.value.latest) |"' >> $GITHUB_STEP_SUMMARY
          else
            echo "All packages are up to date! âœ…" >> $GITHUB_STEP_SUMMARY
          fi

      # License check
      - name: ðŸ“œ Check licenses
        run: |
          npx license-checker --summary --json > licenses.json || true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“œ License Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See licenses.json artifact for details" >> $GITHUB_STEP_SUMMARY

      # Táº¡o summary report
      - name: ðŸ“Š Generate audit report
        run: |
          echo "# ðŸ“¦ Weekly Dependency Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | ${{ steps.npm-audit.outputs.critical }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | ${{ steps.npm-audit.outputs.high }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Moderate | ${{ steps.npm-audit.outputs.moderate }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¢ Low | ${{ steps.npm-audit.outputs.low }} |" >> $GITHUB_STEP_SUMMARY

      # Upload artifacts
      - name: ðŸ“¤ Upload audit reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-reports
          path: |
            npm-audit.json
            outdated.json
            licenses.json
          retention-days: 30

      # Táº¡o issue náº¿u cÃ³ critical/high vulnerabilities
      - name: ðŸš¨ Create issue for vulnerabilities
        if: steps.npm-audit.outputs.critical > 0 || steps.npm-audit.outputs.high > 0
        uses: actions/github-script@v7
        with:
          script: |
            const critical = ${{ steps.npm-audit.outputs.critical }};
            const high = ${{ steps.npm-audit.outputs.high }};

            const title = `ðŸš¨ Security Alert: ${critical} critical, ${high} high vulnerabilities found`;
            const body = `
            ## Weekly Dependency Audit Found Vulnerabilities

            | Severity | Count |
            |----------|-------|
            | ðŸ”´ Critical | ${critical} |
            | ðŸŸ  High | ${high} |

            ### Action Required
            1. Run \`npm audit\` locally to see details
            2. Run \`npm audit fix\` to auto-fix compatible updates
            3. Review and manually update incompatible packages

            ### Resources
            - [npm audit documentation](https://docs.npmjs.com/cli/v8/commands/npm-audit)
            - [Workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            *This issue was created automatically by the Scheduled Maintenance workflow*
            `;

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,dependencies',
              state: 'open'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies', 'automated']
              });
            }

  # ===========================================================================
  # JOB 3: DOCKER IMAGE SCAN
  # QuÃ©t Docker images Ä‘á»‹nh ká»³
  # ===========================================================================
  docker-scan:
    name: ðŸ³ Docker Image Scan
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 2 * * *' ||
      (github.event_name == 'workflow_dispatch' && inputs.task == 'all')

    strategy:
      matrix:
        service:
          - api-gateway
          - auth-service
          - video-service
          - interaction-service
          - notification-service

    steps:
      - name: ðŸ” Scan ${{ matrix.service }} image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}/${{ matrix.service }}:main-latest
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'HIGH,CRITICAL'
        continue-on-error: true

      - name: ðŸ“¤ Upload scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'
        continue-on-error: true

  # ===========================================================================
  # JOB 4: CLEANUP OLD RESOURCES
  # Dá»n dáº¹p resources cÅ©
  # ===========================================================================
  cleanup:
    name: ðŸ§¹ Cleanup Old Resources
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 3 * * 0' ||
      (github.event_name == 'workflow_dispatch' && inputs.task == 'all')

    steps:
      - name: ðŸ§¹ Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10

      - name: ðŸ§¹ Delete old container images
        uses: actions/delete-package-versions@v4
        with:
          package-name: '*'
          package-type: 'container'
          min-versions-to-keep: 10
          delete-only-untagged-versions: true
        continue-on-error: true

  # ===========================================================================
  # JOB 5: SUMMARY
  # ===========================================================================
  summary:
    name: ðŸ“Š Maintenance Summary
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-audit, docker-scan, cleanup]
    if: always()

    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "# ðŸ“Š Scheduled Maintenance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date**: $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Scan | ${{ needs.docker-scan.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cleanup | ${{ needs.cleanup.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
