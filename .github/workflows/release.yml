# =============================================================================
# TIKTOK CLONE - RELEASE WORKFLOW
# =============================================================================
# Workflow nÃ y quáº£n lÃ½ quÃ¡ trÃ¬nh release version má»›i
#
# FLOW:
# 1. Táº¡o release branch tá»« develop
# 2. Update version numbers
# 3. Generate changelog
# 4. Create GitHub Release
# 5. Trigger deployment to staging -> production
# =============================================================================

name: Release Management

on:
  # Trigger thá»§ cÃ´ng vá»›i inputs
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.0)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - major # Breaking changes: 1.0.0 -> 2.0.0
          - minor # New features: 1.0.0 -> 1.1.0
          - patch # Bug fixes: 1.0.0 -> 1.0.1
          - hotfix # Emergency fixes: deploy directly to prod
      description:
        description: 'Release description'
        required: true
        type: string

env:
  NODE_VERSION: '20.x'

jobs:
  # ===========================================================================
  # JOB 1: VALIDATE RELEASE
  # Kiá»ƒm tra cÃ¡c Ä‘iá»u kiá»‡n trÆ°á»›c khi release
  # ===========================================================================
  validate:
    name: âœ… Validate Release
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      branch: ${{ steps.branch.outputs.name }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Validate version format
      - name: ðŸ” Validate version format
        id: version
        run: |
          VERSION="${{ inputs.version }}"

          # Kiá»ƒm tra format semver
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH (e.g., 1.2.0)"
            exit 1
          fi

          # Kiá»ƒm tra version chÆ°a tá»“n táº¡i
          if git tag | grep -q "^v$VERSION$"; then
            echo "âŒ Version v$VERSION already exists!"
            exit 1
          fi

          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version v$VERSION is valid"

      # XÃ¡c Ä‘á»‹nh branch name
      - name: ðŸŒ¿ Determine branch name
        id: branch
        run: |
          RELEASE_TYPE="${{ inputs.release_type }}"
          VERSION="${{ inputs.version }}"

          if [ "$RELEASE_TYPE" == "hotfix" ]; then
            BRANCH="hotfix/$VERSION"
          else
            BRANCH="release/$VERSION"
          fi

          echo "name=$BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸŒ¿ Branch: $BRANCH"

      # Kiá»ƒm tra CI status cá»§a develop branch
      - name: ðŸ” Check CI status
        run: |
          # Láº¥y status cá»§a latest commit trÃªn develop
          COMMIT_SHA=$(git rev-parse origin/develop)

          echo "Checking CI status for commit $COMMIT_SHA..."

          # Sá»­ dá»¥ng GitHub API Ä‘á»ƒ check status
          # (Trong thá»±c táº¿, cáº§n GITHUB_TOKEN vá»›i quyá»n Ä‘á»c statuses)
          echo "âœ… CI check passed (assuming success for demo)"

  # ===========================================================================
  # JOB 2: CREATE RELEASE BRANCH
  # Táº¡o release branch vÃ  update versions
  # ===========================================================================
  create-release:
    name: ðŸŒ¿ Create Release Branch
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Táº¡o release branch
      - name: ðŸŒ¿ Create release branch
        run: |
          BRANCH="${{ needs.validate.outputs.branch }}"
          RELEASE_TYPE="${{ inputs.release_type }}"

          # XÃ¡c Ä‘á»‹nh base branch
          if [ "$RELEASE_TYPE" == "hotfix" ]; then
            BASE_BRANCH="main"
          else
            BASE_BRANCH="develop"
          fi

          # Checkout base vÃ  táº¡o branch má»›i
          git fetch origin $BASE_BRANCH
          git checkout -b $BRANCH origin/$BASE_BRANCH

          echo "âœ… Created branch $BRANCH from $BASE_BRANCH"

      # Update version trong package.json
      - name: ðŸ“ Update version in package.json
        run: |
          VERSION="${{ inputs.version }}"

          # Update root package.json
          npm version $VERSION --no-git-tag-version

          echo "âœ… Updated version to $VERSION"

      # Update version trong Helm Chart
      - name: ðŸ“ Update Helm Chart version
        run: |
          VERSION="${{ inputs.version }}"

          # Update Chart.yaml
          yq -i ".version = \"$VERSION\"" helm/tiktok-clone/Chart.yaml
          yq -i ".appVersion = \"$VERSION\"" helm/tiktok-clone/Chart.yaml

          echo "âœ… Updated Helm chart version to $VERSION"

      # Generate changelog
      - name: ðŸ“œ Generate changelog
        id: changelog
        run: |
          VERSION="${{ inputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          echo "# Changelog for v$VERSION" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ${{ inputs.description }}" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          # Generate commit log
          if [ -n "$PREV_TAG" ]; then
            echo "### Changes since $PREV_TAG" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md

            # Group commits by type
            echo "#### Features" >> RELEASE_NOTES.md
            git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --grep="^feat" >> RELEASE_NOTES.md || true
            echo "" >> RELEASE_NOTES.md

            echo "#### Bug Fixes" >> RELEASE_NOTES.md
            git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --grep="^fix" >> RELEASE_NOTES.md || true
            echo "" >> RELEASE_NOTES.md

            echo "#### Other Changes" >> RELEASE_NOTES.md
            git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --grep="^chore\|^docs\|^refactor" >> RELEASE_NOTES.md || true
          else
            echo "Initial release" >> RELEASE_NOTES.md
          fi

          echo "" >> RELEASE_NOTES.md
          echo "---" >> RELEASE_NOTES.md
          echo "Released by: ${{ github.actor }}" >> RELEASE_NOTES.md
          echo "Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> RELEASE_NOTES.md

          cat RELEASE_NOTES.md

      # Commit vÃ  push changes
      - name: ðŸ“¤ Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add .
          git commit -m "chore(release): prepare release ${{ needs.validate.outputs.version }}

          - Update version to ${{ inputs.version }}
          - Update Helm chart version
          - Generate changelog

          Release type: ${{ inputs.release_type }}
          Description: ${{ inputs.description }}"

          git push -u origin ${{ needs.validate.outputs.branch }}

          echo "âœ… Pushed release branch"

  # ===========================================================================
  # JOB 3: CREATE PULL REQUEST
  # Táº¡o PR tá»« release branch vÃ o main
  # ===========================================================================
  create-pr:
    name: ðŸ“‹ Create Pull Request
    runs-on: ubuntu-latest
    needs: [validate, create-release]

    outputs:
      pr_number: ${{ steps.create-pr.outputs.pull-request-number }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.branch }}

      # Táº¡o PR
      - name: ðŸ“‹ Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: ${{ needs.validate.outputs.branch }}
          title: 'ðŸš€ Release ${{ needs.validate.outputs.version }}'
          body: |
            ## ðŸš€ Release ${{ needs.validate.outputs.version }}

            ### Description
            ${{ inputs.description }}

            ### Release Type
            `${{ inputs.release_type }}`

            ### Checklist
            - [ ] Code review completed
            - [ ] All tests passing
            - [ ] Documentation updated
            - [ ] Staging deployment verified
            - [ ] Ready for production

            ### Deployment
            After merging, this release will be automatically deployed to production.

            ---
            ðŸ¤– This PR was created automatically by the Release workflow.
          labels: |
            release
            ${{ inputs.release_type }}
          draft: false

      - name: ðŸ“¢ PR Created
        run: |
          echo "âœ… Created PR #${{ steps.create-pr.outputs.pull-request-number }}"
          echo "URL: ${{ steps.create-pr.outputs.pull-request-url }}"

  # ===========================================================================
  # JOB 4: DEPLOY TO STAGING
  # Tá»± Ä‘á»™ng deploy release branch lÃªn staging Ä‘á»ƒ test
  # ===========================================================================
  deploy-staging:
    name: ðŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: [validate, create-release]

    environment:
      name: staging
      url: https://staging.tiktok-clone.local

    steps:
      - name: ðŸ“¥ Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.branch }}

      - name: ðŸš€ Trigger staging deployment
        run: |
          echo "ðŸš€ Deploying ${{ needs.validate.outputs.version }} to staging..."

          # Trigger CD workflow cho staging
          # Trong thá»±c táº¿, cÃ³ thá»ƒ dÃ¹ng repository_dispatch hoáº·c workflow_call

          echo "âœ… Staging deployment initiated"

  # ===========================================================================
  # JOB 5: CREATE GITHUB RELEASE (sau khi PR Ä‘Æ°á»£c merge)
  # =============================================================================
  # Note: Job nÃ y sáº½ Ä‘Æ°á»£c trigger bá»Ÿi workflow riÃªng khi PR Ä‘Æ°á»£c merge
  # ÄÃ¢y lÃ  template cho viá»‡c táº¡o release
  # ===========================================================================

  release-summary:
    name: ðŸ“Š Release Summary
    runs-on: ubuntu-latest
    needs: [validate, create-release, create-pr, deploy-staging]
    if: always()

    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "# ðŸ“Š Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ needs.validate.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Type** | ${{ inputs.release_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ needs.validate.outputs.branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **PR** | #${{ needs.create-pr.outputs.pr_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Description** | ${{ inputs.description }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Review the PR" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Verify staging deployment" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Merge PR to trigger production deployment" >> $GITHUB_STEP_SUMMARY
