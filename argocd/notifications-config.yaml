# =============================================================================
# ARGOCD NOTIFICATIONS - C·∫§U H√åNH TH√îNG B√ÅO
# =============================================================================
# File n√†y c·∫•u h√¨nh notifications cho ArgoCD
# G·ª≠i th√¥ng b√°o qua Slack/Teams/Email khi c√≥ events
#
# C√ÅCH S·ª¨ D·ª§NG:
# kubectl apply -f argocd-notifications-cm.yaml -n argocd
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-notifications
    app.kubernetes.io/part-of: argocd
data:
  # ---------------------------------------------------------------------------
  # SERVICES - ƒê·ªãnh nghƒ©a c√°c notification services
  # ---------------------------------------------------------------------------

  # Slack Service
  service.slack: |
    token: $slack-token
    # Token format: xoxb-xxx-xxx-xxx
    # L·∫•y t·ª´: https://api.slack.com/apps ‚Üí OAuth & Permissions

  # Microsoft Teams Service
  service.teams: |
    # Webhook URL format: https://outlook.office.com/webhook/xxx

  # Email Service
  service.email: |
    host: smtp.gmail.com
    port: 587
    from: $email-username
    username: $email-username
    password: $email-password

  # ---------------------------------------------------------------------------
  # TEMPLATES - ƒê·ªãnh nghƒ©a format c·ªßa messages
  # ---------------------------------------------------------------------------

  # Template cho Slack - Sync Started
  template.app-sync-started: |
    message: |
      üîÑ *Application Sync Started*
      Application: {{.app.metadata.name}}
      Environment: {{.app.metadata.labels.environment}}
      Revision: {{.app.status.sync.revision}}
      Triggered by: {{.app.status.operationState.operation.initiatedBy.username}}
    slack:
      attachments: |
        [{
          "color": "#0000FF",
          "fields": [
            {"title": "Application", "value": "{{.app.metadata.name}}", "short": true},
            {"title": "Environment", "value": "{{.app.metadata.labels.environment}}", "short": true},
            {"title": "Revision", "value": "{{.app.status.sync.revision | trunc 7}}", "short": true},
            {"title": "Status", "value": "Syncing...", "short": true}
          ]
        }]

  # Template cho Slack - Sync Succeeded
  template.app-sync-succeeded: |
    message: |
      ‚úÖ *Application Sync Succeeded*
      Application: {{.app.metadata.name}}
      Environment: {{.app.metadata.labels.environment}}
      Revision: {{.app.status.sync.revision}}
    slack:
      attachments: |
        [{
          "color": "#00FF00",
          "fields": [
            {"title": "Application", "value": "{{.app.metadata.name}}", "short": true},
            {"title": "Environment", "value": "{{.app.metadata.labels.environment}}", "short": true},
            {"title": "Revision", "value": "{{.app.status.sync.revision | trunc 7}}", "short": true},
            {"title": "Status", "value": "‚úÖ Synced", "short": true},
            {"title": "Health", "value": "{{.app.status.health.status}}", "short": true}
          ],
          "actions": [
            {
              "type": "button",
              "text": "View in ArgoCD",
              "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}"
            }
          ]
        }]

  # Template cho Slack - Sync Failed
  template.app-sync-failed: |
    message: |
      ‚ùå *Application Sync Failed*
      Application: {{.app.metadata.name}}
      Environment: {{.app.metadata.labels.environment}}
      Error: {{.app.status.operationState.message}}
    slack:
      attachments: |
        [{
          "color": "#FF0000",
          "fields": [
            {"title": "Application", "value": "{{.app.metadata.name}}", "short": true},
            {"title": "Environment", "value": "{{.app.metadata.labels.environment}}", "short": true},
            {"title": "Status", "value": "‚ùå Failed", "short": true},
            {"title": "Error", "value": "{{.app.status.operationState.message | trunc 200}}", "short": false}
          ],
          "actions": [
            {
              "type": "button",
              "text": "View Details",
              "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}"
            },
            {
              "type": "button",
              "text": "Rollback",
              "style": "danger",
              "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=rollback"
            }
          ]
        }]

  # Template cho Health Degraded
  template.app-health-degraded: |
    message: |
      ‚ö†Ô∏è *Application Health Degraded*
      Application: {{.app.metadata.name}}
      Health Status: {{.app.status.health.status}}
    slack:
      attachments: |
        [{
          "color": "#FFA500",
          "fields": [
            {"title": "Application", "value": "{{.app.metadata.name}}", "short": true},
            {"title": "Health", "value": "{{.app.status.health.status}}", "short": true}
          ]
        }]

  # Template cho Deployment Summary
  template.deployment-summary: |
    message: |
      üìä *Deployment Summary*
      Application: {{.app.metadata.name}}
      Environment: {{.app.metadata.labels.environment}}
      From: {{.app.status.history | last | default dict).revision | trunc 7}}
      To: {{.app.status.sync.revision | trunc 7}}
      Duration: {{.app.status.operationState.finishedAt | toDate "2006-01-02T15:04:05Z" | sub (.app.status.operationState.startedAt | toDate "2006-01-02T15:04:05Z") | duration}}
    slack:
      attachments: |
        [{
          "color": "#00FF00",
          "title": "Deployment Completed",
          "fields": [
            {"title": "Application", "value": "{{.app.metadata.name}}", "short": true},
            {"title": "Environment", "value": "{{.app.metadata.labels.environment}}", "short": true},
            {"title": "New Revision", "value": "{{.app.status.sync.revision | trunc 7}}", "short": true},
            {"title": "Health", "value": "{{.app.status.health.status}}", "short": true}
          ]
        }]

  # ---------------------------------------------------------------------------
  # TRIGGERS - ƒê·ªãnh nghƒ©a khi n√†o g·ª≠i notifications
  # ---------------------------------------------------------------------------

  # Trigger khi sync started
  trigger.on-sync-started: |
    - when: app.status.operationState.phase in ['Running']
      send: [app-sync-started]

  # Trigger khi sync succeeded
  trigger.on-sync-succeeded: |
    - when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'
      send: [app-sync-succeeded, deployment-summary]

  # Trigger khi sync failed
  trigger.on-sync-failed: |
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send: [app-sync-failed]

  # Trigger khi health degraded
  trigger.on-health-degraded: |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]

  # Trigger khi deployed (general)
  trigger.on-deployed: |
    - when: app.status.operationState.phase in ['Succeeded']
      send: [app-sync-succeeded]

  # ---------------------------------------------------------------------------
  # DEFAULT TRIGGERS & SUBSCRIPTIONS
  # ---------------------------------------------------------------------------

  # Default triggers cho t·∫•t c·∫£ applications
  defaultTriggers: |
    - on-sync-succeeded
    - on-sync-failed
    - on-health-degraded

  # Context - c√°c bi·∫øn global
  context: |
    argocdUrl: https://argocd.tiktok-clone.local

---
# =============================================================================
# ARGOCD NOTIFICATIONS SECRET
# Ch·ª©a sensitive data cho notifications
# =============================================================================

apiVersion: v1
kind: Secret
metadata:
  name: argocd-notifications-secret
  namespace: argocd
type: Opaque
stringData:
  # Slack Bot Token
  slack-token: xoxb-your-slack-token

  # Email credentials
  email-username: your-email@gmail.com
  email-password: your-app-password

  # Teams webhook (n·∫øu d√πng)
  teams-webhook: https://outlook.office.com/webhook/xxx

---
# =============================================================================
# SLACK CHANNEL SUBSCRIPTIONS
# ƒêƒÉng k√Ω applications v√†o c√°c channels
# =============================================================================
# Th√™m annotations v√†o Application ƒë·ªÉ subscribe notifications:
#
# metadata:
#   annotations:
#     notifications.argoproj.io/subscribe.on-sync-succeeded.slack: deployments
#     notifications.argoproj.io/subscribe.on-sync-failed.slack: alerts
#     notifications.argoproj.io/subscribe.on-health-degraded.slack: alerts
#
# Trong ƒë√≥:
# - 'deployments' v√† 'alerts' l√† Slack channel names
# - Format: notifications.argoproj.io/subscribe.<trigger>.<service>: <recipient>
