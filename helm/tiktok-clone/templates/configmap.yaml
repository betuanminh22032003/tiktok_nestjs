{{- /*
  ConfigMaps for TikTok Clone
  Note: When migration.enabled=true, a pre-hook configmap is created first
*/ -}}

{{- if .Values.migration.enabled }}
---
# Pre-hook ConfigMap - Created before migration job
apiVersion: v1
kind: ConfigMap
metadata:
  name: tiktok-db-config
  namespace: {{ .Values.namespace }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-13"
    "helm.sh/resource-policy": keep
data:
  DB_HOST: postgres.{{ .Values.namespace }}.svc.cluster.local
  DB_PORT: "5432"
  DB_NAME: {{ .Values.postgresql.auth.database }}
  DB_USER: {{ .Values.postgresql.auth.username }}
  REDIS_HOST: redis.{{ .Values.namespace }}.svc.cluster.local
  REDIS_PORT: "6379"
  KAFKA_BROKERS: kafka.{{ .Values.namespace }}.svc.cluster.local:9092
  GRPC_AUTH_URL: {{ .Values.services.auth.name }}.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.services.auth.grpcPort }}
  GRPC_VIDEO_URL: {{ .Values.services.video.name }}.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.services.video.grpcPort }}
  GRPC_INTERACTION_URL: {{ .Values.services.interaction.name }}.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.services.interaction.grpcPort }}
  GRPC_NOTIFICATION_URL: {{ .Values.services.notification.name }}.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.services.notification.grpcPort }}
  NODE_ENV: {{ .Values.global.environment }}
  ENVIRONMENT: {{ .Values.global.environment }}
{{- else }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: tiktok-db-config
  namespace: {{ .Values.namespace }}
data:
  DB_HOST: postgres.{{ .Values.namespace }}.svc.cluster.local
  DB_PORT: "5432"
  DB_NAME: {{ .Values.postgresql.auth.database }}
  DB_USER: {{ .Values.postgresql.auth.username }}
  REDIS_HOST: redis.{{ .Values.namespace }}.svc.cluster.local
  REDIS_PORT: "6379"
  KAFKA_BROKERS: kafka.{{ .Values.namespace }}.svc.cluster.local:9092
  GRPC_AUTH_URL: {{ .Values.services.auth.name }}.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.services.auth.grpcPort }}
  GRPC_VIDEO_URL: {{ .Values.services.video.name }}.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.services.video.grpcPort }}
  GRPC_INTERACTION_URL: {{ .Values.services.interaction.name }}.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.services.interaction.grpcPort }}
  GRPC_NOTIFICATION_URL: {{ .Values.services.notification.name }}.{{ .Values.namespace }}.svc.cluster.local:{{ .Values.services.notification.grpcPort }}
  NODE_ENV: {{ .Values.global.environment }}
  ENVIRONMENT: {{ .Values.global.environment }}
{{- end }}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-gateway-config
  namespace: {{ .Values.namespace }}
data:
  CORS_ORIGIN: 'http://localhost:3000,http://{{- $frontend := .Values.services.frontend -}}{{- if $frontend -}}{{ $frontend.name | default "frontend" }}{{- else -}}frontend{{- end }}.{{ .Values.namespace }}.svc.cluster.local:3000'

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: monitoring-config
  namespace: {{ .Values.namespace }}
data:
  PROMETHEUS_HOST: prometheus.{{ .Values.namespace }}.svc.cluster.local
  PROMETHEUS_PORT: "9090"
  GRAFANA_HOST: grafana.{{ .Values.namespace }}.svc.cluster.local
  GRAFANA_PORT: "3000"
  ELASTICSEARCH_HOST: elasticsearch.{{ .Values.namespace }}.svc.cluster.local
  ELASTICSEARCH_PORT: "9200"
