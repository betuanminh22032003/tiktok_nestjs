{{- if .Values.seeding.enabled }}
# =============================================================================
# Database Seeding Job
# Runs ONCE after fresh install to populate demo data
# Uses the full NestJS seed scripts from scripts/seeders/seed-all.ts
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-db-seed-{{ now | date "20060102150405" }}
  namespace: {{ .Values.namespace }}
  labels:
    app: db-seed
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
  annotations:
    # Run after install only (not on upgrades to avoid duplicate data)
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: {{ .Values.seeding.ttlSecondsAfterFinished | default 300 }}
  backoffLimit: {{ .Values.seeding.backoffLimit | default 2 }}
  activeDeadlineSeconds: {{ .Values.seeding.activeDeadlineSeconds | default 180 }}
  template:
    metadata:
      labels:
        app: db-seed
    spec:
      restartPolicy: Never

      # Init containers to prepare database
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for PostgreSQL..."
              until nc -z postgres 5432; do
                echo "PostgreSQL not ready, waiting..."
                sleep 2
              done
              echo "PostgreSQL is ready!"
          resources:
            requests:
              memory: "32Mi"
              cpu: "10m"
            limits:
              memory: "64Mi"
              cpu: "50m"

        - name: create-databases
          image: postgres:15-alpine
          command:
            - sh
            - -c
            - |
              echo "Creating databases..."
              for DB in tiktok_auth tiktok_video tiktok_interaction tiktok_notification; do
                echo "Creating $DB..."
                PGPASSWORD=$POSTGRES_PASSWORD psql -h postgres -U $POSTGRES_USER -tc \
                  "SELECT 1 FROM pg_database WHERE datname = '$DB'" | grep -q 1 || \
                PGPASSWORD=$POSTGRES_PASSWORD psql -h postgres -U $POSTGRES_USER -c \
                  "CREATE DATABASE $DB"
              done
              echo "All databases created!"
          env:
            - name: POSTGRES_USER
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tiktok-db-secrets
                  key: DB_PASSWORD
          resources:
            requests:
              memory: "32Mi"
              cpu: "10m"
            limits:
              memory: "64Mi"
              cpu: "50m"

      containers:
        - name: seed
          image: "{{ .Values.seeding.image.repository | default "tiktok-seeder" }}:{{ .Values.seeding.image.tag | default "v1" }}"
          imagePullPolicy: {{ .Values.global.imagePullPolicy | default "IfNotPresent" }}
          env:
            # Auth DB
            - name: AUTH_DB_HOST
              value: postgres
            - name: AUTH_DB_PORT
              value: "5432"
            - name: AUTH_DB_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_USER
            - name: AUTH_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tiktok-db-secrets
                  key: DB_PASSWORD
            - name: AUTH_DB_NAME
              value: tiktok_auth
            # Video DB
            - name: VIDEO_DB_HOST
              value: postgres
            - name: VIDEO_DB_PORT
              value: "5432"
            - name: VIDEO_DB_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_USER
            - name: VIDEO_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tiktok-db-secrets
                  key: DB_PASSWORD
            - name: VIDEO_DB_NAME
              value: tiktok_video
            # Interaction DB
            - name: INTERACTION_DB_HOST
              value: postgres
            - name: INTERACTION_DB_PORT
              value: "5432"
            - name: INTERACTION_DB_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: tiktok-db-config
                  key: DB_USER
            - name: INTERACTION_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tiktok-db-secrets
                  key: DB_PASSWORD
            - name: INTERACTION_DB_NAME
              value: tiktok_interaction
            # Reduce Node.js memory to fit in limits
            - name: NODE_OPTIONS
              value: "--max-old-space-size=384"
          resources:
            requests:
              memory: "384Mi"
              cpu: "200m"
            limits:
              memory: "512Mi"
              cpu: "500m"
{{- end }}
