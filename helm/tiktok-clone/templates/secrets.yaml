{{- /*
  Secrets for TikTok Clone
  Note: When migration.enabled=true, DB secrets are created as pre-hook in postgres-prehook.yaml
*/ -}}

{{- if .Values.migration.enabled }}
---
# Pre-hook Secret for database - includes all DB passwords
apiVersion: v1
kind: Secret
metadata:
  name: tiktok-db-secrets
  namespace: {{ .Values.namespace | default "default" }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-13"
    "helm.sh/resource-policy": keep
type: Opaque
stringData:
  DB_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
  POSTGRES_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
  AUTH_DB_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
  VIDEO_DB_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
  INTERACTION_DB_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
  NOTIFICATION_DB_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
{{- else }}
---
apiVersion: v1
kind: Secret
metadata:
  name: tiktok-db-secrets
  namespace: {{ .Values.namespace | default "default" }}
type: Opaque
stringData:
  DB_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
  POSTGRES_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
  AUTH_DB_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
  VIDEO_DB_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
  INTERACTION_DB_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
  NOTIFICATION_DB_PASSWORD: {{ .Values.postgresql.auth.password | quote }}
{{- end }}

---
apiVersion: v1
kind: Secret
metadata:
  name: tiktok-jwt-secrets
  namespace: {{ .Values.namespace | default "default" }}
type: Opaque
stringData:
  JWT_ACCESS_SECRET: {{ .Values.secrets.jwt.accessSecret | quote }}
  JWT_REFRESH_SECRET: {{ .Values.secrets.jwt.refreshSecret | quote }}

---
apiVersion: v1
kind: Secret
metadata:
  name: grafana-secrets
  namespace: {{ .Values.namespace | default "default" }}
type: Opaque
stringData:
  GF_SECURITY_ADMIN_PASSWORD: {{ .Values.secrets.grafana.adminPassword | quote }}
