# Prometheus Recording Rules - Pre-compute expensive queries
groups:
  - name: http_metrics
    interval: 1m
    rules:
      # Request rate per service
      - record: http:requests:rate1m
        expr: rate(http_requests_total[1m])

      - record: http:requests:rate5m
        expr: rate(http_requests_total[5m])

      # Error rate per service
      - record: http:errors:rate5m
        expr: rate(http_request_errors_total[5m])

      # Error rate percentage
      - record: http:error_ratio:5m
        expr: |
          (rate(http_request_errors_total[5m]) / rate(http_requests_total[5m])) * 100

      # Response time percentiles
      - record: http:request_duration:p50
        expr: histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))

      - record: http:request_duration:p95
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

      - record: http:request_duration:p99
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))

  - name: database_metrics
    interval: 1m
    rules:
      # Database query rate
      - record: db:query:rate5m
        expr: rate(database_query_duration_seconds_count[5m])

      # Slow query rate
      - record: db:slow_queries:rate5m
        expr: rate(database_query_duration_seconds_bucket{le="+Inf"}[5m]) - rate(database_query_duration_seconds_bucket{le="1"}[5m])

      # Query duration percentiles
      - record: db:query_duration:p95
        expr: histogram_quantile(0.95, rate(database_query_duration_seconds_bucket[5m]))

      - record: db:query_duration:p99
        expr: histogram_quantile(0.99, rate(database_query_duration_seconds_bucket[5m]))

  - name: cache_metrics
    interval: 1m
    rules:
      # Cache hit rate
      - record: cache:hit_ratio:5m
        expr: |
          (rate(cache_hits_total[5m]) / (rate(cache_hits_total[5m]) + rate(cache_misses_total[5m]))) * 100

      # Cache operations per second
      - record: cache:ops:rate5m
        expr: rate(cache_hits_total[5m]) + rate(cache_misses_total[5m])

  - name: system_metrics
    interval: 1m
    rules:
      # CPU usage percentage
      - record: node:cpu_usage:percent
        expr: (1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m]))) * 100

      # Memory usage percentage
      - record: node:memory_usage:percent
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100

      # Disk usage percentage
      - record: node:disk_usage:percent
        expr: (1 - (node_filesystem_avail_bytes{fstype!~"tmpfs"} / node_filesystem_size_bytes{fstype!~"tmpfs"})) * 100

  - name: postgres_metrics
    interval: 1m
    rules:
      # Active connections ratio
      - record: pg:connections:ratio
        expr: pg_stat_activity_count / pg_settings_max_connections

      # Cache hit ratio
      - record: pg:cache_hit_ratio
        expr: |
          sum(rate(pg_stat_database_heap_blks_hit{datname!~"template.*"}[5m])) /
          (sum(rate(pg_stat_database_heap_blks_hit{datname!~"template.*"}[5m])) +
           sum(rate(pg_stat_database_heap_blks_read{datname!~"template.*"}[5m])))

  - name: uptime_metrics
    interval: 1m
    rules:
      # Service uptime
      - record: up:services
        expr: up{job=~".*service|prometheus|alertmanager"}

      # Service availability percentage
      - record: service:availability:1h
        expr: avg_over_time(up{job=~".*service"}[1h]) * 100
