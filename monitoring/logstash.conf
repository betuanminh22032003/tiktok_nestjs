input {
  # Receive logs from Docker
  udp {
    port => 5000
    type => "docker"
    codec => json
  }

  # Receive logs from applications via syslog
  syslog {
    port => 5514
    type => "syslog"
  }

  # File input for application logs
  file {
    path => "/logs/**/*.log"
    type => "application"
    codec => json
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  # Parse application logs
  if [type] == "application" {
    mutate {
      add_field => {
        "[@metadata][index_name]" => "logs-application-%{+YYYY.MM.dd}"
      }
    }
  }

  # Parse docker logs
  if [type] == "docker" {
    mutate {
      add_field => {
        "[@metadata][index_name]" => "logs-docker-%{+YYYY.MM.dd}"
      }
    }
  }

  # Parse syslog
  if [type] == "syslog" {
    grok {
      match => { "message" => "%{SYSLOGLINE}" }
    }
    mutate {
      add_field => {
        "[@metadata][index_name]" => "logs-syslog-%{+YYYY.MM.dd}"
      }
    }
  }

  # Add timestamp and metadata
  mutate {
    add_field => {
      "processed_at" => "%{@timestamp}"
      "environment" => "${ENVIRONMENT:production}"
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index_name]}"
    user => "elastic"
    password => "changeme"
  }

  # Also output to stdout for debugging
  stdout {
    codec => rubydebug
  }
}
